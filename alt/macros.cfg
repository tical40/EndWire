[gcode_macro LOAD_MESH_TEMP]
gcode:
  {% set bed_temp = params.BED_TEMPERATURE|default(0)%}
  {% set force = params.FORCE|default(0)%}
  {action_respond_info("- AUTOMATED BED MESH GENERATOR -")}
  {% if bed_temp|int < 30 %}
    {action_respond_info("Your bed temp is to low, make sure it is at least 30 or higher")}
  {% else %}
    {% if printer.configfile.config["bed_mesh Bed_Temp-" + bed_temp|string + "C"] is defined and force|int == 0 %}
      BED_MESH_CLEAR
      BED_MESH_PROFILE LOAD=Bed_Temp-{bed_temp|string}C
      G28 Z
      {action_respond_info("Succesfully loaded bed_mesh Bed_Temp-" + bed_temp|string + "C")}
    {% else %}
      {% if printer.configfile.config["bed_mesh Bed_Temp-" + bed_temp|string + "C"] is defined and force|int == 1 %}
        BED_MESH_PROFILE REMOVE=Bed_Temp-{bed_temp|string}C
      {% endif %}
      {action_respond_info("bed_mesh not defined, your bed temperature will go up!")}
      {action_respond_info("We will probe the bed and save the mesh as bed_mesh Bed_Temp-" + bed_temp|string + "C")}
      M190 S{bed_temp} # Wait for the bed to hit bed_temp
      BED_MESH_CALIBRATE
      BED_MESH_PROFILE SAVE=Bed_Temp-{bed_temp|string}C
      BED_MESH_PROFILE REMOVE=default
    {% endif %}
  {% endif %}

[gcode_macro PREHEATANDMESH]
variable_parameter_T_EXTRUDER: 0
variable_parameter_T_BED: 0
gcode:
    M104 S{T_EXTRUDER}
    M190 S{T_BED}
    G28
    M109 S{T_EXTRUDER}
    LOAD_MESH_TEMP BED_TEMPERATURE={T_BED}
    G28
    
[gcode_macro PREHEAT60]
gcode:
  PREHEATANDMESH T_BED=60 T_EXTRUDER=140

[gcode_macro PREHEAT80]
gcode:
  PREHEATANDMESH T_BED=80 T_EXTRUDER=140

[gcode_macro TEST]
gcode:
  G90
  G1 X20 Y20 Z10 F1600
  G1 X120 Y120 F1600
  G1 X200 Y120 F1600
  G1 X200 Y200 F1600
  G1 X20 Y180 F1600
  G1 X200 Y20 F1600  